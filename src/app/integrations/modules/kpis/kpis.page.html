<ion-header [translucent]="true" style="box-shadow: none !important;">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false">
        <ion-button size="large" (click)="ToggleMenu()">
          <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-menu-button>
    </ion-buttons><ion-title>KPIs</ion-title>

    <div slot="end" class="card-select flex flex-wrap justify-center items-end gap-4">
      <p-floatlabel class="w-full md:w-56" variant="on">
        <p-select [(ngModel)]="organizationSelected" inputId="organization_select"
          [options]="userData.Company.Organizations" optionLabel="Name" [filter]="true" filterBy="Name"
          placeholder="Seleccione una organización" styleClass="w-full" [virtualScroll]="true"
          [virtualScrollItemSize]="38" (onChange)="GetMachines()" appendTo="body" />
        <label for="organization_select">Organización</label>
      </p-floatlabel>
    </div>
    <div slot="end" class="card-select flex flex-wrap justify-center items-end gap-4">
      <p-floatlabel class="w-full md:w-56" variant="on">
        <p-select [(ngModel)]="dateRange" inputId="date_range_select" [options]="dateRangeOptions" optionLabel="label" (onChange)="ResetData()"
          optionValue="value" appendTo="body" />
        <label for="date_range_select">Período</label>
      </p-floatlabel>
    </div>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true">
  <ion-grid>
    <ion-row>
      <ion-col size="6">
        <ion-card>
          <p-table #dtCampaigns [value]="machinesArray" dataKey="Code" styleClass="card-table-primeng wo-table-custom"
            [tableStyle]="{ 'height': '100%'}" [size]="'small'" [rowHover]="true" [paginator]="true"
            [rows]="rowsPerPage" [selectionMode]="'multiple'" [(selection)]="selectedMachines"
            [globalFilterFields]="['code', 'name', 'status', 'coils']"(onRowSelect)="toggleRowSelection($event.data)" (onRowUnselect)="onRowUnselect($event.data)" 
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
            [showCurrentPageReport]="true" [filterDelay]="0" stripedRows [scrollable]="true"
            [scrollHeight]="scrollHeight" [sortOrder]="1">

            <ng-template #caption>
              <div class="table-caption">
                <div class="table-caption-left">
                  <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpiar"
                    (click)="ClearMachinesFilter(dtCampaigns)" />
                  <div style="font-size: 17px;">
                    Máquinas
                    <span *ngIf="selectedMachines && selectedMachines.length > 0"
                      style="font-size: 14px; color: #6c757d; margin-left: 8px;">
                      ({{ selectedMachines.length }} seleccionada{{ selectedMachines.length > 1 ? 's' : '' }})
                    </span>
                  </div>
                </div>
                <div class="table-caption-right">
                  <p-iconField iconPosition="left">
                    <p-inputIcon>
                      <i class="fas fa-search"></i>
                    </p-inputIcon>
                    <input pInputText type="text" [(ngModel)]="searchValueAl"
                      (input)="OnFilterGlobal($event, dtCampaigns)" placeholder="Buscar" />
                  </p-iconField>
                </div>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="code" class="td-center">
                  <div class="flex justify-between items-center">
                    Code
                    <p-sortIcon field="code" />
                    <p-columnFilter type="text" field="code" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="name" class="td-center">
                  <div class="flex justify-between items-center">
                    Nombre
                    <p-sortIcon field="name" />
                    <p-columnFilter type="text" field="name" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="Status" class="td-center">
                  <div class="flex justify-between items-center">
                    Status
                    <p-sortIcon field="Status" />
                    <p-columnFilter type="text" field="Status" display="menu" class="ml-auto" />
                  </div>
                </th>
                <!-- Columna sin título -->
                <th class="td-center" style="width: 4rem"></th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-item>
              <tr class="clickable-row ion-activatable row-with-actions" [pSelectableRow]="item">
                <td class="td-center">
                  <p-tag [value]="item.Code" severity="contrast"></p-tag>
                </td>
                <td class="td-center">
                  <strong>{{ item.Name }}</strong>
                </td>
                <td class="td-center">
                  <p-tag [value]="item.Status" [severity]="item.Status === 'No Signal'? 'warn': 
        item.Status === 'Downtime'? 'danger': item.Status === 'Runtime'
        ? 'success': 'danger'"></p-tag>
                </td>
                <td class="td-center action-cell">
                  <ion-icon *ngIf="selectedRowMachine == item" name="checkmark-circle" class="checkmark-icon"
                    color="success"></ion-icon>
                </td>

                <ion-ripple-effect></ion-ripple-effect>
              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="4">No se encontraron máquinas para esta organización.</td>
              </tr>
            </ng-template>
          </p-table>
        </ion-card>
      </ion-col>
      <ion-col size="6">
        <ion-card class="graphic">
          <ion-card-header>
            <ion-card-title>Timeline</ion-card-title>
          </ion-card-header>
          <app-simple-timeline [data]="timeLineData"></app-simple-timeline>
          <ion-card-content>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
    <ion-row>
      <ion-col size="6">
        <ion-card class="graphic">
          <ion-card-header>
            <ion-card-title>Estadísticas</ion-card-title>
          </ion-card-header>
          <app-simple-donut [data]="donutData"></app-simple-donut>
          <ion-card-content>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <!--ion-col size=" 4">
        <ion-card class="graphic">
          <ion-card-header>
            <ion-card-title>Mapa de calor</ion-card-title>
          </ion-card-header>
          <app-simple-heatmap></app-simple-heatmap>
          <ion-card-content>
          </ion-card-content>
        </ion-card>
      </ion-col-->
      <ion-col size="6">
        <ion-card class="graphic">
          <ion-card-header>
            <ion-card-title>Areas más recurrentes</ion-card-title>
          </ion-card-header>
          <app-simple-column-bar [data]="barsData"></app-simple-column-bar>
          <ion-card-content>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>