<ion-header [translucent]="true" style="box-shadow: none !important;" xmlns="http://www.w3.org/1999/html">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false">
        <ion-button size="large" (click)="ToggleMenu()">
          <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-menu-button>
    </ion-buttons>
    <ion-title>Fallas {{userData.Company.Name}}</ion-title>
  </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true">
  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <ion-card>
          <p-table #dtFailures
                   [value]="failuresData.items"
                   [(selection)]="selectedFailures"
                   dataKey="failure_id"
                   [columns]="cols"
                   styleClass="card-table-primeng wo-table-custom"
                   [tableStyle]="{ 'height': '100%'}"
                   [size]="'small'"
                   [rowHover]="true"
                   [paginator]="true"
                   [rows]="rowsPerPage"
                   [globalFilterFields]="['failure_id', 'name', 'type', 'area']"
                   currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} datos"
                   [showCurrentPageReport]="true"
                   [filterDelay]="0"
                   stripedRows
                   [scrollable]="true"
                   [scrollHeight]="scrollHeight"
                   [sortOrder]="1"
                   [exportHeader]="'customExportHeader'">
            <ng-template pTemplate="caption">
              <div class="table-caption-container">
                <div class="left-section">
                  <p-button
                    [outlined]="true"
                    icon="pi pi-filter-slash"
                    label="Limpiar"
                    (click)="ClearAlerts(dtFailures)" />

                  <p-button
                    [outlined]="true"
                    icon="pi pi-plus-circle"
                    label="Nueva"
                    variant="outlined"
                    severity="info"
                    (click)="isModalNewOpen = true" />

                  <div class="title-text">
                    Tabla de fallas
                  </div>
                </div>

                <div class="right-section">
                  <p-button
                    *ngIf="selectedFailures.length > 0"
                    [outlined]="true"
                    icon="far fa-trash-can"
                    label="Eliminar"
                    variant="outlined"
                    severity="danger"
                    (click)="DeleteFailure()" />

                  <p-button
                    [outlined]="true"
                    icon="fas fa-download"
                    variant="outlined"
                    severity="contrast"
                    label="Exportar"
                    (click)="ExportCSV()" />

                  <p-iconField iconPosition="left">
                    <p-inputIcon>
                      <i class="fas fa-search"></i>
                    </p-inputIcon>
                    <input
                      pInputText
                      type="text"
                      [(ngModel)]="searchValueAl"
                      (input)="OnFilterGlobal($event, dtFailures)"
                      placeholder="Buscar" />
                  </p-iconField>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="header">
              <tr>
                <th style="width: 4rem" class="td-center">
                  <p-tableHeaderCheckbox/>
                </th>
                <th pSortableColumn="failure_id" style="min-width: 4rem" class="td-center">
                  <div class="flex justify-between items-center">
                    Id
                    <p-sortIcon field="failure_id" />
                    <p-columnFilter type="text" field="FailureId" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="name" style="min-width: 7rem" class="td-center">
                  <div class="flex justify-between items-center">
                    Nombre de la falla
                    <p-sortIcon field="name" />
                    <p-columnFilter type="text" field="name" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="type" style="min-width: 7rem">
                  <div class="flex justify-between items-center">
                    Tipo
                    <p-sortIcon field="type" />
                    <p-columnFilter field="type" matchMode="equals" display="menu" class="ml-auto"/>
                  </div>
                </th>
                <th pSortableColumn="area" style="min-width: 7rem" class="td-center">
                  <div class="flex justify-between items-center">
                    Area
                    <p-sortIcon field="area" />
                    <p-columnFilter field="area" matchMode="equals" display="menu" class="ml-auto"/>
                  </div>
                </th>
                <th pSortableColumn="Actions" style="min-width:6rem" class="td-center">
                  <div class="flex justify-between items-center">
                    Acciones
                  </div>
                </th>
            </ng-template>
            <ng-template pTemplate="body" let-item>
              <tr>
                <td class="td-center">
                  <p-tableCheckbox [value]="item"/>
                </td>
                <td class="td-center">{{ item.failure_id }}</td>
                <td ><strong>{{ item.name }}</strong></td>
                <td>{{item.type}}</td>
                <td class="td-center">
                  <p-tag [value]="item.area"
                         [severity]="item.area === 'Mantenimiento' ? 'danger' : item.area === 'Almacén' ? 'info' : item.area === 'Producción' ? 'success' : item.area === 'Calidad' ? 'warn' : '' ">
                  </p-tag>
                </td>
                <td class="td-center">
                  <ion-button size="small" shape="round" color="success" (click)="EditableForm(item)" title="Editar"
                    *ngIf="permissions.isSuperAdmin()">
                    <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
                  </ion-button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5">No se encontraron fallas.</td>
              </tr>
            </ng-template>
          </p-table>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Modal para New -->
  <p-dialog [modal]="true"
            [(visible)]="isModalNewOpen"
            styleClass="responsive-pdialog"
            [draggable]="true"
            [resizable]="true"
            [maximizable]="true"
            appendTo="body">
    <!-- Header personalizado-->
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <span>{{ isEditMode ? 'Editar falla' : 'Nueva falla' }}</span>
      </div>
    </ng-template>

    <ion-grid [fixed]="true">
      <ion-item>
        <ion-input
          placeholder="Nombre"
          [(ngModel)]="formFailure.name"
          name="name">
          <div slot="label">
            <ion-text color="primary">Nombre:</ion-text>
            <ion-text color="danger"> *</ion-text>
          </div>
        </ion-input>
      </ion-item>

      <ion-item>
        <ion-label color="primary">
          Tipo:
          <ion-text color="danger"> *</ion-text>
        </ion-label>
        <p-select
          slot="end"
          [options]="ftypes"
          [(ngModel)]="formFailure.type"
          placeholder="Seleccione tipo de falla"
          [showClear]="true"
          appendTo="body"/>
      </ion-item>

      <ion-item>
        <ion-label color="primary">
          Áreas:
          <ion-text color="danger"> *</ion-text>
        </ion-label>
        <p-select
          slot="end"
          [options]="areas"
          [(ngModel)]="formFailure.area"
          placeholder="Seleccione área"
          [showClear]="true"
          appendTo="body"/>
      </ion-item>
    </ion-grid>

    <ng-template pTemplate="footer">
      <p-button label="Cancelar" severity="danger" (click)="isModalNewOpen = false;" />
      <p-button
        [label]="isEditMode ? 'Actualizar' : 'Guardar'"
        severity="success"
        (click)="CreateOrUpdateFailure()"
        [disabled]="!isFormValid()" />
    </ng-template>
  </p-dialog>
</ion-content>
