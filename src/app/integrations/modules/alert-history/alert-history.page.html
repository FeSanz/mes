<ion-header [translucent]="true" style="box-shadow: none !important;">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button></ion-back-button>
      <!--ion-menu-button autoHide="false">
        <ion-button size="large" (click)="ToggleMenu()">
          <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-menu-button-->
    </ion-buttons><ion-title>Historial de alertas</ion-title>

    <div slot="end" class="card-select flex flex-wrap justify-center items-end gap-4">
      <p-floatlabel class="w-full md:w-56" variant="on">
        <p-select [(ngModel)]="organizationSelected" inputId="organization_select"
          [options]="userData.Company.Organizations" optionLabel="Name" [filter]="true" filterBy="Name"
          placeholder="Seleccione una organización" styleClass="w-full" [virtualScroll]="true"
          [virtualScrollItemSize]="38" (onChange)="GetAlerts()" appendTo="body" />
        <label for="organization_select">Organización</label>
      </p-floatlabel>
      <p-floatlabel class="w-full md:w-56" variant="on">
        <p-select [(ngModel)]="dateRange" inputId="date_range_select" [options]="dateRangeOptions" optionLabel="label"
          (onChange)="GetAlerts()" optionValue="value" appendTo="body" />
        <label for="date_range_select">Período</label>
      </p-floatlabel>
    </div>
    <div slot="end" class="card-select flex flex-wrap justify-center items-end gap-4" *ngIf="showDateTime">
      <p-datepicker slot="end" [(ngModel)]="startDate" [showTime]="true" [showIcon]="true" [readonlyInput]="true"
        (ngModelChange)="GetAlerts()" inputStyleClass="no-border-bg" [maxDate]="endDate" dateFormat="dd/mm/yy"
        hourFormat="12" appendTo="body"> </p-datepicker>

      <p-datepicker slot="end" [(ngModel)]="endDate" [showTime]="true" [showIcon]="true" [readonlyInput]="true"
        (ngModelChange)="GetAlerts()" inputStyleClass="no-border-bg" [minDate]="startDate" dateFormat="dd/mm/yy"
        hourFormat="12" appendTo="body">
      </p-datepicker>

    </div>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <ion-grid>
    <ion-row>
      <ion-col size="12">
        <ion-card>
          <p-table #dtFinalicedAlerts [value]="finalicedAlertsData" dataKey="alert_id"
            styleClass="card-table-primeng wo-table-custom" [tableStyle]="{ 'height': '100%'}" [size]="'small'"
            [rowHover]="true" [paginator]="true" [rows]="rowsPerPage"
            [globalFilterFields]="['alert_id', 'name', 'type', 'area', 'machine_name', 'status']"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} datos"
            [showCurrentPageReport]="true" [filterDelay]="0" stripedRows [scrollable]="true"
            [scrollHeight]="scrollHeight" [sortOrder]="1">
            <ng-template #caption>
              <div class="table-caption">
                <div class="table-caption-left">
                  <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpiar"
                    (click)="ClearAlerts(dtFinalicedAlerts)" />
                  <div style="font-size: 17px;">
                    Alertas Finalizadas
                  </div>
                </div>

                <div class="table-caption-right">
                  <p-iconField iconPosition="left">
                    <p-inputIcon>
                      <i class="fas fa-search"></i>
                    </p-inputIcon>
                    <input pInputText type="text" [(ngModel)]="searchValueAl"
                      (input)="OnFilterGlobal($event, dtFinalicedAlerts)" placeholder="Buscar" />
                  </p-iconField>
                </div>
              </div>
            </ng-template>
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="alert_id" class="td-center" style="min-width: 5rem">
                  <div class="flex justify-between items-center">
                    Id
                    <p-sortIcon field="alert_id" />
                    <p-columnFilter type="text" field="alert_id" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="name" class="td-center">
                  <div class="flex justify-between items-center">
                    Falla
                    <p-sortIcon field="name" />
                    <p-columnFilter type="text" field="name" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="type" class="td-center">
                  <div class="flex justify-between items-center">
                    Tipo
                    <p-sortIcon field="type" />
                    <p-columnFilter type="text" field="type" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="area" class="td-center">
                  <div class="flex justify-between items-center">
                    Area
                    <p-sortIcon field="area" />
                    <p-columnFilter type="text" field="area" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="machine_name" class="td-center">
                  <div class="flex justify-between items-center">
                    Máquina
                    <p-sortIcon field="machine_name" />
                    <p-columnFilter type="text" field="machine_name" display="menu" class="ml-auto" />
                  </div>
                </th>
                <!--th pSortableColumn="status" class="td-center">
                  <div class="flex justify-between items-center">
                    Estado
                    <p-sortIcon field="status" />
                    <p-columnFilter type="text" field="status" display="menu" class="ml-auto" />
                  </div>
                </th-->
                <th pSortableColumn="start_date" class="td-center">
                  <div class="flex justify-between items-center">
                    Inicio
                    <p-sortIcon field="start_date" />
                    <p-columnFilter type="text" field="start_date" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="response_time" class="td-center">
                  <div class="flex justify-between items-center">
                    Tiempo de respuesta
                    <p-sortIcon field="response_time" />
                    <p-columnFilter type="text" field="response_time" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="repair_time" class="td-center">
                  <div class="flex justify-between items-center">
                    Tiempo de reparación
                    <p-sortIcon field="repair_time" />
                    <p-columnFilter type="text" field="repair_time" display="menu" class="ml-auto" />
                  </div>
                </th>
                <th pSortableColumn="repair_time" class="td-center">
                  <div class="flex justify-between items-center">
                    Finalizada
                    <p-sortIcon field="repair_time" />
                    <p-columnFilter type="text" field="repair_time" display="menu" class="ml-auto" />
                  </div>
                </th>
                <!--th class="td-center">
                  <div class="flex justify-between items-center">
                    Acciones
                  </div>
                </th-->
            </ng-template>
            <ng-template #body let-item>
              <tr>
                <td class="td-center">{{item.alert_id}}</td>
                <td><strong>{{ item.name }}</strong></td>
                <td class="td-center">{{item.type}}</td>
                <td class="td-center">
                  <p-tag [value]="item.area"
                    [severity]="item.area === 'Mantenimiento' ? 'danger' : item.area === 'Almacén' ? 'info' : item.area === 'Producción' ? 'success' : item.area === 'Calidad' ? 'warn' : '' ">
                  </p-tag>
                </td>
                <td class="td-center">{{ item.machine_name}}</td>
                <!--td class="td-center">
                  <p-tag
                    [value]="item.status == 'open' ? 'Pendiente' : item.status == 'attending' ? 'Atender' : item.status == 'assigned' ? 'Reparando' : item.status == 'completed' ? 'Finalizada' : ''"
                    [severity]="item.status == 'open' ? 'warn' : item.status == 'attending' ? 'danger' : item.status == 'assigned' ? 'warn' : item.status == 'completed' ? 'success' : '' ">
                    <ion-icon
                      [name]="item.status == 'open' ? 'time-outline' : item.status == 'attending' ? 'warning-outline' : item.status == 'assigned' ? 'time-outline' : item.status == 'completed' ? 'checkmark-outline' : ''"></ion-icon>
                  </p-tag>
                </td-->
                <td class="td-center">{{ item.start_date | date: 'dd/MM/yy HH:mm' }}</td>
                <td class="td-center" [title]="item.responseLegibleTimeString">
                  <ng-container *ngIf="item.responseTimeString as time">
                    <ng-container *ngIf="time.split(':') as parts">
                      <p-tag severity="secondary" [value]="parts[0]"></p-tag>
                      :
                      <p-tag severity="secondary" [value]="parts[1]"></p-tag>
                      :
                      <p-tag severity="secondary" [value]="parts[2]"></p-tag>
                    </ng-container>
                  </ng-container>
                </td>
                <td class="td-center" [title]="item.repairLegibleTimeString">
                  <ng-container *ngIf="item.repairTimeString as time">
                    <ng-container *ngIf="time.split(':') as parts">
                      <p-tag severity="secondary" [value]="parts[0]"></p-tag>
                      :
                      <p-tag severity="secondary" [value]="parts[1]"></p-tag>
                      :
                      <p-tag severity="secondary" [value]="parts[2]"></p-tag>
                    </ng-container>
                  </ng-container>
                </td>
                <td class="td-center">
                  {{ item.repair_time | date: 'dd/MM/yy HH:mm' }}
                </td>
                <!--td class="td-center">
                  <ion-button size="small" shape="round" color="danger" (click)="DeleteAlert(item)" title="Eliminar">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </td-->
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5">No se encontraron alertas en este periodo de tiempo.</td>
              </tr>
            </ng-template>
          </p-table>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>