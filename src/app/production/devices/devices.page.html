<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>Dispositivos</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-grid>
    <ion-row>
      <ion-col size="12" size-sm="12" size-md="6" size-lg="4" size-xl="3" *ngFor="let machine of machines">
        <ion-card color="light" (click)="openAsEditMachine(machine)" class="card-button ion-activatable ripple-parent"
          button><ion-ripple-effect></ion-ripple-effect>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="hardware-chip-outline" slot="start" style="margin-right: 8px;"></ion-icon>
              <span style="color: var(--ion-color-primary);">{{ machine.machine_name }}</span>
            </ion-card-title>
            <ion-note color="medium">Token: <strong>{{ machine.token }}</strong></ion-note>
          </ion-card-header>
          <ion-card-content>
            <ion-row justify-content-start>
              <ion-col size="auto" *ngFor="let sensor of machine.sensors" style="text-align: center;">
                <ion-button fill="clear" size="large" shape="round" [title]="sensor.sensor_name + '\n' + (sensor.last_date_time | date: 'short')">
                  <ion-icon [name]="sensor.sensor_icon" slot="icon-only"></ion-icon>
                </ion-button>
                <div class="sensor-value">
                  {{ sensor.last_value !== null ? sensor.last_value : '—' }}
                </div>
              </ion-col>
              <ion-col size="auto" style="text-align: center;">
                <ion-button fill="clear" size="large" shape="round" title="Agregar nuevo sensor">
                  <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
                </ion-button>
                <div class="sensor-value">
                  Agregar
                </div>
              </ion-col>
              <!--ion-col size="auto" *ngFor="let sensor of machine.sensors" class="ion-text-center">
                </ion-col-->
            </ion-row>
          </ion-card-content>
        </ion-card>
      </ion-col>
      <ion-col size="12" size-sm="12" size-md="6" size-lg="4" size-xl="3">
        <ion-card color="light" (click)="openAsNewMachine()" class="card-button ion-activatable ripple-parent"
          button><ion-ripple-effect></ion-ripple-effect>
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="hardware-chip-outline" slot="start" style="margin-right: 8px;"></ion-icon>
              <span style="color: var(--ion-color-primary);">Nuevo dispositivo</span>
            </ion-card-title>
            <ion-note color="medium">Token: <strong>-</strong></ion-note>
          </ion-card-header>
          <ion-card-content>
            <ion-row class="ion-justify-content-center">
              <ion-col size="auto" class="ion-text-center">
                <ion-button fill="clear" size="large" shape="round" title="Agregar nuevo dispositivo">
                  <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
                </ion-button>
                <div class="sensor-value">
                  Agregar dispositivo
                </div>
              </ion-col>
            </ion-row>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>
  </ion-grid>

  <ion-modal [isOpen]="isModalOpen" (ionModalWillDismiss)="isModalOpen = false">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Agregar nuevo dispositivo</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="isModalOpen = false">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <ion-item>
          <ion-input type="text" placeholder="Torno CNC" [(ngModel)]="machine.machine_name" style="text-align: right;">
            <div slot="label"><ion-text color="primary">Nombre:</ion-text></div>
          </ion-input>
        </ion-item>
        <ion-item>
          <ion-input type="text" placeholder="MCH-101" [(ngModel)]="machine.code" style="text-align: right;">
            <div slot="label"><ion-text color="primary">Código:</ion-text></div>
          </ion-input>
        </ion-item>
        <ion-item>
          <span style="color: var(--ion-color-primary);" slot="start"> Token:</span>
          <ion-text slot="end"> {{machine.token}} </ion-text>
          <ion-buttons slot="end">
            <ion-button shape="round" title="copiar" color="primary" (click)="copyFromInputToken()">
              <ion-icon name="copy-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <!--ion-button shape="round" title="pegar" color="primary" (click)="pasteOnInputToken()">
              <ion-icon name="document-outline" slot="icon-only"></ion-icon>
            </ion-button-->
          </ion-buttons>
        </ion-item>
        <ion-item-sliding *ngFor="let sensor of machine.sensors" lines="full">
          <!-- Contenido principal -->
          <ion-item style="--background: var(--ion-color-back-shade, #fff); --border-radius: 8px;">
            <ion-grid>
              <!-- Fila 1: Nombre + Variable -->
              <ion-row class="ion-align-items-center ion-justify-content-between">
                <ion-col size="12" size-md="6">
                  <ion-input type="text" placeholder="nombre" [(ngModel)]="sensor.name" style="text-align: right;">
                    <div slot="label">
                      <ion-text color="primary">Sensor:</ion-text>
                    </div>
                  </ion-input>
                </ion-col>
                <ion-col size="12" size-md="6">
                  <ion-input type="text" placeholder="variable" [(ngModel)]="sensor.var"
                    style="text-align: right;">
                    <div slot="label">
                      <ion-text color="primary">Variable:</ion-text>
                    </div>
                  </ion-input>
                </ion-col>
              </ion-row>
              <!-- Fila 2: Iconos -->
              <ion-row class="ion-justify-content-center ion-justify-content-md-start ion-align-items-center"
                style="gap: 8px;">
                <ion-col size="auto" *ngFor="let icon of iconList" class="ion-text-center">
                  <ion-button fill="outline" shape="round" size="default" (click)="selectIcon(sensor, icon.name)"
                    [title]="icon.name" [color]="sensor.icon === icon.name ? 'primary' : 'medium'">
                    <ion-icon [name]="icon.name" slot="icon-only"></ion-icon>
                  </ion-button>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-item>
          <ion-item-options side="end">
            <ion-item-option color="danger" (click)="removeSensor(sensor)">
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            </ion-item-option>
          </ion-item-options>

        </ion-item-sliding>
        <ion-item lines="none">
        </ion-item>
        <div class="ion-text-center">
          <ion-button fill="outline" (click)="addNewSensor()">
            <ion-icon slot="start" name="add"></ion-icon>
            Agregar sensor</ion-button>
        </div>
        <ion-fab slot="fixed" vertical="bottom" horizontal="start" *ngIf="!machine.isNew">
          <ion-fab-button (click)="deleteMachine()" color="danger">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-fab-button>
        </ion-fab>
        <ion-fab slot="fixed" vertical="bottom" horizontal="end">
          <ion-fab-button (click)="machine.isNew ? addNewMachine() : updateMachine()">
            <ion-icon name="checkmark-outline"></ion-icon>
          </ion-fab-button>
        </ion-fab>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>