<ion-header [translucent]="true" style="box-shadow: none !important;">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false">
        <ion-button size="large" (click)="ToggleMenu()">
          <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-menu-button>
    </ion-buttons>
    <ion-title>
      <ion-breadcrumbs>
        <ion-breadcrumb href="/grid-data">Registros</ion-breadcrumb>
        <ion-breadcrumb href="/RegOrganizations">Organizaciones {{userData.Company.Name}}</ion-breadcrumb>
      </ion-breadcrumbs>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="ion-margin">
    <div>
      <p-table #dtDB [value]="dbData.items" dataKey="OrganizationId" [(selection)]="selectedOrg"
        styleClass="card-table-primeng" class="ion-margin tabla-centrada" [tableStyle]="{ 'min-width': '50rem'}"
        [size]="'small'" [rowHover]="true" [rows]="rowsPerPage" [showCurrentPageReport]="true"
        [rowsPerPageOptions]="rowsPerPageOptions" [paginator]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} datos" [filterDelay]="0"
        [globalFilterFields]="['Code', 'Name', 'Location', 'WorkMethod']" stripedRows [scrollable]="true"
        [scrollHeight]="GetScrollHeight()" [alwaysShowPaginator]="true">

        <ng-template pTemplate="caption">
          <div class="table-caption-container">
            <div class="left-section">
              <p-button [outlined]="true" icon="pi pi-filter-slash" label="Limpiar" (click)="ClearData(dtDB)" />

              <p-button [outlined]="true" icon="pi pi-plus-circle" label="Nueva" variant="outlined" severity="info"
                (click)="OpenAsNewOrganization()" />

            </div>
            <div class="right-section">
              <p-button *ngIf="selectedOrg.length > 0" [outlined]="true" icon="pi pi-delete-left" label="Eliminar"
                variant="outlined" severity="danger" (click)="DeleteOrganizations()" />

              <p-iconField iconPosition="left">
                <p-inputIcon>
                  <i class="fas fa-search"></i>
                </p-inputIcon>
                <input pInputText type="text" [(ngModel)]="searchValueDB" (input)="OnFilterGlobal($event, dtDB)"
                  placeholder="Buscar" />
              </p-iconField>
            </div>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th style="width: 4rem" class="td-center">
              <p-tableHeaderCheckbox />
            </th>
            <th pSortableColumn="ID" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                ID
                <p-sortIcon field="ID" />
                <p-columnFilter type="text" field="ID" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Code" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Código
                <p-sortIcon field="Code" />
                <p-columnFilter type="text" field="Code" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Name" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Nombre
                <p-sortIcon field="Name" />
                <p-columnFilter type="text" field="Name" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Location" style="min-width: 14rem">
              <div class="flex justify-between items-center">
                Ubicación
                <p-sortIcon field="Location" />
                <p-columnFilter type="text" field="Location" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="WorkMethod" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Mét. trab.
                <p-sortIcon field="WorkMethod" />
                <p-columnFilter field="WorkMethod" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Coordinates" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Coord.
                <p-sortIcon field="Coordinates" />
                <p-columnFilter field="Coordinates" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Acciones" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Editar
                <p-sortIcon field="Acciones" />
                <p-columnFilter field="Acciones" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td class="td-center">
              <p-tableCheckbox [value]="item" />
            </td>
            <td>{{ item.OrganizationId }}</td>
            <td>{{ item.Code }}</td>
            <td>{{ item.Name }}</td>
            <td>{{ item.Location }}</td>
            <td>{{ item.WorkMethod }}</td>
            <td>{{ formatPoint(item.Coordinates) }}</td>
            <td>
              <ion-button size="small" shape="round" color="success" title="Editar"
                (click)="$event.stopPropagation(); EditOrganization(item)">
                <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
              </ion-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No se encontraron organizaciones.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <p-dialog [modal]="true" [(visible)]="isModalOpen" [style]="{ height: '60vh', 'max-height': '90vh' }"
    [draggable]="true" [resizable]="true" [maximizable]="true" appendTo="body">

    <!-- Header personalizado-->
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <span>
          {{ isNewFlag ? 'Nueva organización' : 'Editar organización' }}
        </span>
      </div>
    </ng-template>

    <!-- Contenido principal del diálogo -->
    <div class="dialog-content-wrapper">
      <ion-item>
        <ion-input placeholder="Código" [(ngModel)]="org.Code" name="Code" required>
          <div slot="label"><ion-text color="primary">Código:</ion-text></div>
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-input placeholder="Nombre" [(ngModel)]="org.Name" name="Name" required>
          <div slot="label"><ion-text color="primary">Nombre:</ion-text></div>
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-input 
          placeholder="Ubicación"           
          [(ngModel)]="org.Location" 
          (click)="openLocationSelector()" 
          name="Location" 
          required 
          readonly>
          <div slot="label"><ion-text color="primary">Ubicación:</ion-text></div>
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-label color="primary">
          Método de trabajo:          
        </ion-label>
        <p-select 
          slot="end"
          [options]="types" 
          [(ngModel)]="org.WorkMethod" 
          placeholder="Seleccione una opción" 
          [showClear]="true" 
          appendTo="body">                    
        </p-select>
      </ion-item>
      <!-- <ion-item>
        <ion-input placeholder="Coordenadas" [(ngModel)]="org.Coordinates" name="Coordinates" required readonly>
          <div slot="label"><ion-text color="primary">Coordenadas:</ion-text></div>
        </ion-input>
      </ion-item> -->
    </div>

    <!-- Footer con botones -->
    <ng-template pTemplate="footer">

      <p-button label="Cancelar" severity="danger" (click)="isModalOpen = false; RefreshTables();" />

      <p-button [disabled]="!org?.Code?.trim() || !org?.Name?.trim() || !org?.Location?.trim() || 
          !org?.WorkMethod?.trim()" label="Guardar" severity="success"
        (click)="AddOrEditOrganization()" />

    </ng-template>
  </p-dialog>

  <p-dialog 
    [modal]="true" 
    [(visible)]="isMapOpen" 
    [style]="{ height: '60vh', 'max-height': '90vh' }"
    [draggable]="true" 
    [resizable]="true" 
    [maximizable]="true" 
    appendTo="body"
    (onHide)="onMapDialogHide()">
    
    <ng-template pTemplate="header">
        <div class="dialog-header">
            <span>Seleccionar Ubicación en el Mapa</span>
        </div>
    </ng-template>

    <div class="map-dialog-content">
        <div id="map" style="height: 100%; width: 100%;"></div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-between align-center w-full">
            <div>
                <small *ngIf="selectedCoords" class="text-color-secondary">
                    Coordenadas: {{ selectedCoords.lat | number:'1.4-4' }}, {{ selectedCoords.lng | number:'1.4-4' }}
                </small>
                <small *ngIf="!selectedCoords" class="text-color-secondary">
                    Haz clic en el mapa para seleccionar coordenadas
                </small>              
            </div>
            <div>
                <p-button 
                    label="Cancelar" 
                    severity="danger" 
                    (click)="isMapOpen = false;" 
                    class="ion-margin-end" />

                <p-button 
                    label="Confirmar" 
                    severity="success" 
                    (click)="confirmSelection()" 
                    [disabled]="!selectedCoords" />
            </div>
        </div>
    </ng-template>
  </p-dialog>
</ion-content>