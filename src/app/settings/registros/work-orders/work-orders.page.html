<ion-header [translucent]="true" style="box-shadow: none !important;">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button autoHide="false">
        <ion-button size="large" (click)="ToggleMenu()">
          <ion-icon name="menu-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-menu-button>
    </ion-buttons>
    <ion-title>
      <ion-breadcrumbs>
        <ion-breadcrumb href="/grid-data">Registros</ion-breadcrumb>
        <ion-breadcrumb href="/work-orders">Órdenes de trabajo {{userData.Company.Name}}</ion-breadcrumb>
      </ion-breadcrumbs>
    </ion-title>
    <div class="card-select flex flex-wrap justify-center items-end gap-4" slot="end">
      <p-floatlabel class="w-full md:w-56" variant="on">
        <p-select [(ngModel)]="organizationSelected" inputId="organization_select"
          [options]="dbOrganizations.Company.Organizations" optionLabel="Name" [filter]="true" filterBy="Name"
          placeholder="Seleccione una organización" styleClass="w-full" [virtualScroll]="true"
          [virtualScrollItemSize]="38" (onChange)="OnOrganizationSelected()" 
          appendTo="body"/>
        <label for="organization_select">Organización</label>
      </p-floatlabel>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content>
<div class="ion-margin">
    <div>
      <p-table #dtDB [value]="dbData.items" 
        dataKey="WorkOrderId" 
        [(selection)]="selectedWO"
        styleClass="card-table-primeng"
        class="ion-margin tabla-centrada" 
        [tableStyle]="{ 'min-width': '50rem'}" 
        [size]="'small'" 
        [rowHover]="true"
        [rows]="rowsPerPage"         
        [showCurrentPageReport]="true" 
        [rowsPerPageOptions]="rowsPerPageOptions"         
        [paginator]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} datos" 
        [filterDelay]="0"
        [globalFilterFields]="['WorkOrderId', 'WorkOrderNumber', 'StartDate', 'CompletionDate', 'Status', 'ItemNumber']" 
        stripedRows [scrollable]="true"
        [scrollHeight]="GetScrollHeight()" 
        [alwaysShowPaginator]="true">

        <ng-template pTemplate="caption">
          <div class="table-caption-container">
            <div class="left-section">
              <p-button 
                [outlined]="true" 
                icon="pi pi-filter-slash" 
                label="Limpiar" 
                (click)="ClearData(dtDB)" />

              <p-button
                [outlined]="true"
                icon="pi pi-plus-circle"
                label="Nuevo"
                variant="outlined"
                severity="info"
                (click)="OpenAsNewWorkOrder()" />

            </div>
            <div class="right-section">
              <p-button
                    *ngIf="selectedWO.length > 0"
                    [outlined]="true"
                    icon="pi pi-delete-left"
                    label="Eliminar"
                    variant="outlined"
                    severity="danger"
                    (click)="DeleteWorkOrders()" />

              <p-iconField iconPosition="left">
                <p-inputIcon>
                  <i class="fas fa-search"></i>
                </p-inputIcon>
                <input pInputText 
                  type="text" 
                  [(ngModel)]="searchValueDB" 
                  (input)="OnFilterGlobal($event, dtDB)"
                  placeholder="Buscar" 
                />
              </p-iconField>
            </div>
          </div>
        </ng-template>

        <ng-template pTemplate="header">
          <tr>
            <th style="width: 4rem" class="td-center">
              <p-tableHeaderCheckbox/>
            </th>
            <th pSortableColumn="ID" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                ID
                <p-sortIcon field="ID" />
                <p-columnFilter type="text" field="ID" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="WorkOrderNumber" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                O.T
                <p-sortIcon field="WorkOrderNumber" />
                <p-columnFilter type="text" field="WorkOrderNumber" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="PlannedQuantity" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                C. meta
                <p-sortIcon field="PlannedQuantity" />
                <p-columnFilter type="text" field="PlannedQuantity" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="CompletedQuantity" style="min-width: 14rem">
              <div class="flex justify-between items-center">
                C. completa
                <p-sortIcon field="CompletedQuantity" />
                <p-columnFilter type="text" field="CompletedQuantity" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="StartDate" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                F. inicio
                <p-sortIcon field="StartDate" />
                <p-columnFilter field="StartDate" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="CompletioDate" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                F. fin
                <p-sortIcon field="CompletionDate" />
                <p-columnFilter field="CompletionDate" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
            <th pSortableColumn="Status" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Status
                <p-sortIcon field="Status" />
                <p-columnFilter field="Status" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>  
            <th pSortableColumn="Type" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Tipo
                <p-sortIcon field="Type" />
                <p-columnFilter field="Type" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th> 
            <th pSortableColumn="ResourceCode" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Máquina
                <p-sortIcon field="ResourceCode" />
                <p-columnFilter field="ResourceCode" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th> 
            <th pSortableColumn="ItemNumber" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Producto
                <p-sortIcon field="ItemNumber" />
                <p-columnFilter field="ItemNumber" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th> 
            <th pSortableColumn="Description" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Descrip.
                <p-sortIcon field="Description" />
                <p-columnFilter field="Description" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>                                                            
            <th pSortableColumn="UoM" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                UOM
                <p-sortIcon field="UoM" />
                <p-columnFilter field="UoM" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>             
            <th pSortableColumn="Acciones" style="min-width: 10rem">
              <div class="flex justify-between items-center">
                Editar
                <p-sortIcon field="Acciones" />
                <p-columnFilter field="Acciones" matchMode="equals" display="menu" class="ml-auto" />
              </div>
            </th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-item>
          <tr>
            <td class="td-center">
              <p-tableCheckbox [value]="item"/>
            </td>
            <td>{{ item.WorkOrderId }}</td>
            <td>{{ item.WorkOrderNumber }}</td>
            <td>{{ item.PlannedQuantity }}</td>
            <td>{{ item.CompletedQuantity }}</td>
            <td>{{ item.StartDate | date:'dd/MM/yy HH:mm' }}</td>                        
            <td>{{ item.CompletionDate | date:'dd/MM/yy HH:mm' }}</td>            
            <td>{{ item.Status }}</td>            
            <td>{{ item.Type }}</td>            
            <td>{{ item.ResourceCode }}</td>            
            <td>{{ item.ItemNumber }}</td>            
            <td>{{ item.Description }}</td>            
            <td>{{ item.UoM }}</td>            
            <td>
              <ion-button size="small" shape="round" color="success" title="Editar"
                (click)="$event.stopPropagation(); EditWorkOrder(item)">
                <ion-icon slot="icon-only" name="pencil-outline"></ion-icon>
              </ion-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">No se encontraron Órdenes de Trabajo.</td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <p-dialog [modal]="true" [(visible)]="isModalOpen" [style]="{ height: '60vh', 'max-height': '90vh' }"
    [draggable]="true" [resizable]="true" [maximizable]="true" appendTo="body">
    
    <ng-template pTemplate="header">
      <div class="dialog-header">
        <span>
          {{ isNewFlag ? 'Nueva OT' : 'Editar OT' }}
        </span>
      </div>
    </ng-template>
    
    <div class="dialog-content-wrapper">
      <ion-item>
        <ion-input placeholder="O.T" [(ngModel)]="wo.WorkOrderNumber" name="WorkOrderNumber" required>
          <div slot="label"><ion-text color="primary">O.T:</ion-text></div>
        </ion-input>
      </ion-item>
      <ion-item>
        <ion-input type="number" [min]="0" placeholder="C. planeada" [(ngModel)]="wo.PlannedQuantity" name="PlannedQuantity" required>
          <div slot="label"><ion-text color="primary">C. planeada:</ion-text></div>
        </ion-input>
      </ion-item>  
      <ion-item *ngIf="!isNewFlag">
        <ion-input placeholder="C. completa" [(ngModel)]="wo.CompletedQuantity" name="CompletedQuantity" required>
          <div slot="label"><ion-text color="primary">C. completa:</ion-text></div>
        </ion-input>
      </ion-item>                
      <ion-item>
        <ion-label style="color: var(--ion-color-primary);" slot="start">F. inicio:</ion-label> 
        <p-datepicker 
          inputId="startDate" 
          [(ngModel)]="wo.StartDate" 
          [minDate]="actualDate"
          [showTime]="true" 
          [hourFormat]="'24'" 
          showIcon 
          iconDisplay="input"
          appendTo="body"/>
      </ion-item>
      <ion-item>
        <ion-label style="color: var(--ion-color-primary);" slot="start">F. fin:</ion-label> 
        <p-datepicker 
          inputId="completionDate" 
          [(ngModel)]="wo.CompletionDate" 
          [minDate]="wo.StartDate"
          [showTime]="true" 
          [hourFormat]="'24'" 
          showIcon 
          iconDisplay="input"
          appendTo="body"/>
      </ion-item>
      <ion-item>
        <ion-label style="color: var(--ion-color-primary);" slot="start">Máquina:</ion-label> 
        <p-select 
          [(ngModel)]="wo.MachineId" 
          interface="popover" 
          placeholder="Máquina"                   
          slot="end"
          [options]="transformedMachines"
          [showClear]="true"
          appendTo="body" >          
        </p-select>                
      </ion-item>
      <ion-item>
        <ion-label style="color: var(--ion-color-primary);" slot="start">Producto:</ion-label> 
        <p-select 
          [(ngModel)]="wo.ItemId" 
          interface="popover" 
          placeholder="Producto"                   
          slot="end"
          [options]="transformedItems"
          [showClear]="true"
          appendTo="body" >          
        </p-select> 
      </ion-item>
    </div>
    
    <ng-template pTemplate="footer">

      <p-button 
        label="Cancelar" 
        severity="danger" 
        (click)="isModalOpen = false;" 
      />

      <p-button 
        [disabled]="!wo?.WorkOrderNumber || !wo?.PlannedQuantity || wo.CompletedQuantity === '' || wo.CompletedQuantity === null 
        || wo.CompletedQuantity < 0 || !wo?.Status || !wo?.StartDate || !wo?.CompletionDate || !wo?.Type || !wo?.MachineId || !wo?.ItemId" 
        label="Guardar" 
        severity="success" 
        (click)="AddOrEditWorkOrder()"
      />         

    </ng-template>
  </p-dialog>
</ion-content>





